# SPDX-FileCopyrightText: The Gommitlint Action Authors
#
# SPDX-License-Identifier: CC0-1.0

name: Release

on:
  push:
    tags:
      - v[0-9]+.[0-9]+.[0-9]+

# Tool versions are defined in scripts/ci/versions.env
permissions:
  contents: read

env:
  GITHUB_SERVER: ${{ github.server_url }}
  GITHUB_REPO: ${{ github.repository }}
  GITHUB_REF_NAME: ${{ github.ref_name }}

jobs:
  prepare:
    permissions:
      contents: write
    name: Prepare release
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: success() && startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Check required secrets
        env:
          SECRET_SSH_KEY: ${{ secrets.SSH_SIGNING_KEY_RELEASE }}
        run: |
          echo "Checking required secrets are configured..."
          MISSING=""
          if [[ -z "${SECRET_SSH_KEY}" ]]; then
            MISSING="${MISSING}  - SSH_SIGNING_KEY_RELEASE (for signing and pushing)\n"
          fi
          if [[ -n "$MISSING" ]]; then
            echo "ERROR: Missing required secrets:"
            echo -e "$MISSING"
            echo "Please configure these secrets in the repository or organization settings."
            exit 1
          fi
          echo "All required secrets configured."

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Cache mise tools
        id: cache-mise-tools
        uses: actions/cache@v4
        with:
          path: ~/.local/share/mise
          key: mise-${{ runner.os }}-${{ hashFiles('.mise.toml') }}
          restore-keys: |
            mise-${{ runner.os }}-

      - name: Install mise
        run: |
          ./scripts/ci/install-tool.sh mise
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"
          mkdir -p ~/.local/share/mise
          echo "$HOME/.local/share/mise/shims" >> "$GITHUB_PATH"

      - name: Trust mise config
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          mise trust

      - name: Install tools
        env:
          MISE_YES: "1"
          MISE_GITHUB_TOKEN: ${{ secrets.GH_RATE_LIMIT_TOKEN }}
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          mise install

      - name: Commit changelog
        env:
          SSH_SIGNING_KEY: ${{ secrets.SSH_SIGNING_KEY_RELEASE }}
        run: |
          eval "$(mise activate bash)"
          ./scripts/ci/commit-changelog.sh "${GITHUB_REF_NAME}" "${GITHUB_REPO}"

  release:
    needs: prepare
    permissions:
      contents: write
    name: Create release
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install mise
        run: |
          ./scripts/ci/install-tool.sh mise
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"
          mkdir -p ~/.local/share/mise
          echo "$HOME/.local/share/mise/shims" >> "$GITHUB_PATH"

      - name: Trust mise config
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          mise trust

      - name: Install tools
        env:
          MISE_YES: "1"
        run: |
          sudo apt-get update && sudo apt-get install -y jq
          export PATH="$HOME/.local/bin:$PATH"
          mise install

      - name: Generate release notes
        run: |
          VERSION="${GITHUB_REF_NAME}"
          VERSION_NUM="${VERSION#v}"

          # Generate changelog for this version only
          eval "$(mise activate bash)"
          git-chglog --config .chglog/config.yml "$VERSION" > changelog-content.md

          # Build release notes
          {
            printf '## gommitlint-action %s\n\n' "$VERSION_NUM"
            tail -n +4 changelog-content.md
            printf '\n---\n\n'
            printf '**Usage:** See [README](https://github.com/itiquette/gommitlint-action#quick-start)\n'
          } > release-notes.md

          rm -f changelog-content.md
          echo "Generated release-notes.md ($(wc -l < release-notes.md) lines)"
          cat release-notes.md

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          body_path: release-notes.md
          draft: false
          prerelease: false
