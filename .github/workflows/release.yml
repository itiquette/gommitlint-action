# SPDX-FileCopyrightText: The Gommitlint Action Authors
#
# SPDX-License-Identifier: CC0-1.0

name: Release

on:
  push:
    tags:
      - v[0-9]+.[0-9]+.[0-9]+

permissions:
  contents: read

jobs:
  release:
    if: false  # Disabled until install-tool.sh is fixed
    permissions:
      contents: write
    name: Create release
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install mise
        run: |
          ./scripts/ci/install-tool.sh mise
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"
          mkdir -p ~/.local/share/mise
          echo "$HOME/.local/share/mise/shims" >> "$GITHUB_PATH"

      - name: Trust mise config
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          mise trust

      - name: Install tools
        env:
          MISE_YES: "1"
        run: |
          sudo apt-get update && sudo apt-get install -y jq
          export PATH="$HOME/.local/bin:$PATH"
          mise install

      - name: Generate release notes
        run: |
          VERSION="${{ github.ref_name }}"
          VERSION_NUM="${VERSION#v}"

          # Generate changelog for this version only
          eval "$(mise activate bash)"
          git-chglog --config .chglog/config.yml "$VERSION" > changelog-content.md

          # Build release notes
          {
            printf '## gommitlint-action %s\n\n' "$VERSION_NUM"
            tail -n +4 changelog-content.md
            printf '\n---\n\n'
            printf '**Usage:** See [README](https://github.com/itiquette/gommitlint-action#quick-start)\n'
          } > release-notes.md

          rm -f changelog-content.md
          echo "Generated release-notes.md ($(wc -l < release-notes.md) lines)"
          cat release-notes.md

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          body_path: release-notes.md
          draft: false
          prerelease: false
